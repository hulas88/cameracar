<!DOCTYPE html>
<html>
<head>
  <title>Gesture Control Car - HTTPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ‚úÖ MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <style>
    body { font-family: Arial; text-align: center; margin: 0; padding: 10px; }
    video { width: 95%; max-width: 420px; border: 2px solid black; border-radius: 12px; }
    h2 { margin: 10px 0; }
    .cmd { font-size: 26px; font-weight: bold; color: green; margin: 10px 0; }
    .btn { font-size: 18px; padding: 10px 20px; margin: 10px; border-radius: 10px; }
    .info { font-size: 16px; margin-top: 10px; }
  </style>
</head>

<body>
  <h2>üì±‚úã Gesture Control Car (HTTPS)</h2>

  <div class="cmd" id="cmdText">Command: S</div>

  <button class="btn" onclick="startCam()">‚úÖ Start Camera</button>

  <div class="info">
    ‚òùÔ∏è 1 Finger = Forward | ‚úåÔ∏è 2 Fingers = Backward <br>
    üëç Thumb Left = Left | üëç Thumb Right = Right | ‚úä Fist = Stop
  </div>

  <br>
  <video id="video" autoplay playsinline></video>

<script>
  const videoElement = document.getElementById("video");
  const cmdText = document.getElementById("cmdText");

  // ‚úÖ Put your ESP32 IP here (from Serial Monitor)
  const ESP32_IP = "192.168.29.221";
  const ESP32_URL = `http://${ESP32_IP}/cmd?cmd=`;

  let lastCmd = "S";
  let lastSendTime = Date.now();

  function sendCmd(cmd) {
    if (cmd !== lastCmd && Date.now() - lastSendTime > 200) {
      fetch(ESP32_URL + cmd).catch(err => console.log("ESP32 Error:", err));
      lastCmd = cmd;
      lastSendTime = Date.now();
      cmdText.innerText = "Command: " + cmd;
    }
  }

  // ‚úÖ MediaPipe Hands Setup
  const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });

  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
  });

  // ‚úÖ Finger Up Detection
  function isFingerUp(tip, pip) {
    return tip.y < pip.y;
  }

  hands.onResults(results => {
    // ‚úÖ If no hand detected
    if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
      sendCmd("S");
      return;
    }

    const lm = results.multiHandLandmarks[0];

    // ‚úÖ Landmarks
    const wrist = lm[0];

    const thumbTip = lm[4];

    const indexTip = lm[8];
    const indexPip = lm[6];

    const middleTip = lm[12];
    const middlePip = lm[10];

    const ringTip = lm[16];
    const ringPip = lm[14];

    const pinkyTip = lm[20];
    const pinkyPip = lm[18];

    // ‚úÖ Fingers state (excluding thumb)
    const indexUp  = isFingerUp(indexTip, indexPip);
    const middleUp = isFingerUp(middleTip, middlePip);
    const ringUp   = isFingerUp(ringTip, ringPip);
    const pinkyUp  = isFingerUp(pinkyTip, pinkyPip);

    // ‚úÖ Count number of fingers up
    let fingers = 0;
    if (indexUp) fingers++;
    if (middleUp) fingers++;
    if (ringUp) fingers++;
    if (pinkyUp) fingers++;

    let command = "S"; // default stop

    // ‚úÖ 1 Finger = Forward (Index only)
    if (fingers == 1 && indexUp) {
      command = "U";
    }

    // ‚úÖ 2 Fingers = Backward (Index + Middle)
    else if (fingers == 2 && indexUp && middleUp) {
      command = "D";
    }

    // ‚úÖ Left/Right only if Forward/Backward not active
    else {
      if (thumbTip.x < wrist.x - 0.08) command = "L";
      else if (thumbTip.x > wrist.x + 0.08) command = "R";
      else command = "S";
    }

    sendCmd(command);
  });

  async function startCam() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
      });

      videoElement.srcObject = stream;

      async function loop() {
        await hands.send({ image: videoElement });
        requestAnimationFrame(loop);
      }
      loop();

    } catch (err) {
      alert("‚ùå Camera Error: " + err);
    }
  }
</script>

</body>
</html>
