<!DOCTYPE html>
<html>
<head>
  <title>Gesture Car Control - HTTPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <style>
    body { font-family: Arial; text-align: center; margin: 0; padding: 10px; }
    video { width: 95%; max-width: 420px; border: 2px solid black; border-radius: 12px; margin-top: 10px; }
    h2 { margin: 10px 0; }
    .cmd { font-size: 26px; font-weight: bold; color: green; margin: 10px 0; }
    .status { font-size: 16px; color: blue; margin: 5px 0; }
    .btn { font-size: 16px; padding: 10px 14px; margin: 6px; border-radius: 10px; }
  </style>
</head>

<body>
  <h2>üì±‚úã Gesture Control Car</h2>

  <div class="cmd" id="cmdText">Command: S</div>
  <div class="status" id="statusText">Status: Not Sending</div>

  <button class="btn" onclick="startCam()">‚úÖ Start Camera</button>

  <h3>‚úÖ Test Buttons (Check ESP32 Serial Monitor)</h3>
  <button class="btn" onclick="manualSend('U')">U Forward</button>
  <button class="btn" onclick="manualSend('D')">D Backward</button>
  <button class="btn" onclick="manualSend('L')">L Left</button>
  <button class="btn" onclick="manualSend('R')">R Right</button>
  <button class="btn" onclick="manualSend('S')">S Stop</button>

  <video id="video" autoplay playsinline></video>

<script>
  const videoElement = document.getElementById("video");
  const cmdText = document.getElementById("cmdText");
  const statusText = document.getElementById("statusText");

  // ‚úÖ Change this to your ESP32 IP shown in Serial Monitor
  const ESP32_IP = "192.168.29.221";

  // ‚úÖ SEND COMMAND FUNCTION (Image Trick)
  function sendCommand(cmd) {
    statusText.innerText = "Status: Sending " + cmd + " ...";

    // Image request works better than fetch in HTTPS -> HTTP
    const img = new Image();
    img.src = `http://${ESP32_IP}/cmd?cmd=${cmd}&t=${Date.now()}`;

    console.log("‚úÖ Sent:", cmd);

    setTimeout(() => {
      statusText.innerText = "Status: Sent " + cmd;
    }, 200);
  }

  let lastCmd = "S";
  let lastSendTime = Date.now();

  function sendCmd(cmd) {
    if (cmd !== lastCmd && Date.now() - lastSendTime > 200) {
      sendCommand(cmd);
      lastCmd = cmd;
      lastSendTime = Date.now();
      cmdText.innerText = "Command: " + cmd;
    }
  }

  function manualSend(cmd) {
    cmdText.innerText = "Command: " + cmd;
    sendCommand(cmd);
  }

  // ‚úÖ MediaPipe Hands
  const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });

  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
  });

  function isFingerUp(tip, pip) {
    return tip.y < pip.y;
  }

  hands.onResults(results => {
    if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
      sendCmd("S");
      return;
    }

    const lm = results.multiHandLandmarks[0];

    const wrist = lm[0];
    const thumbTip = lm[4];

    const indexTip = lm[8];
    const indexPip = lm[6];

    const middleTip = lm[12];
    const middlePip = lm[10];

    const ringTip = lm[16];
    const ringPip = lm[14];

    const pinkyTip = lm[20];
    const pinkyPip = lm[18];

    const indexUp  = isFingerUp(indexTip, indexPip);
    const middleUp = isFingerUp(middleTip, middlePip);
    const ringUp   = isFingerUp(ringTip, ringPip);
    const pinkyUp  = isFingerUp(pinkyTip, pinkyPip);

    let fingers = 0;
    if (indexUp) fingers++;
    if (middleUp) fingers++;
    if (ringUp) fingers++;
    if (pinkyUp) fingers++;

    let command = "S";

    // ‚úÖ 1 finger = Forward
    if (fingers === 1 && indexUp) {
      command = "U";
    }

    // ‚úÖ 2 finger = Backward
    else if (fingers === 2 && indexUp && middleUp) {
      command = "D";
    }

    // ‚úÖ Left/Right by thumb
    else {
      if (thumbTip.x < wrist.x - 0.08) command = "L";
      else if (thumbTip.x > wrist.x + 0.08) command = "R";
      else command = "S";
    }

    sendCmd(command);
  });

  async function startCam() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
      });

      videoElement.srcObject = stream;

      async function loop() {
        await hands.send({ image: videoElement });
        requestAnimationFrame(loop);
      }
      loop();

    } catch (err) {
      alert("‚ùå Camera Error: " + err);
      console.log(err);
    }
  }
</script>

</body>
</html>
